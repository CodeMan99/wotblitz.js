var https = require('https');
var program = require('commander');
var querystring = require('querystring');

var app_id = require('./config/app.json').application_id;
var config = require('./config/api.json').players;

module.exports = {
  list: list,
  info: info,
  achievements: achievements
};

main(
  program
    .option('-s, --search [name]', 'search for a player')
    .parse(process.argv)
);

function main(options) {
  list(options.search, function(err, data) {
    if (err) throw err;
    console.dir(data)
  });
}

function list(search, callback) {
  var body = querystring.stringify({
    application_id: app_id,
    search: search
  });

  var options = config.list;
  options.hostname = config.hostname;
  options.headers = {
    'Content-Type': 'application/x-www-form-urlencoded',
    'Content-Length': body.length
  };

  request_collect(options, body, function(err, data) {
    if (err) return callback(err);

    callback(null, JSON.parse(data).data);
  });
}

function info() {
}

function achievements() {
}

function request_collect(options, body, callback) {
  var req = https.request(options, function(response) {
    var data = [];
    response.setEncoding('utf8');
    response.on('data', Array.prototype.push.bind(data));
    response.on('end', function() {
      callback(null, data.join(''));
    });
  });

  req.on('error', callback);
  req.write(body);
  req.end();
}
